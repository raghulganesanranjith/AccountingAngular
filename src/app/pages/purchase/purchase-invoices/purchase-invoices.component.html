<div class="purchase-invoices-container">
  <!-- Header -->
  <div class="header">
    <div class="header-content">
      <h1>Purchase Invoices</h1>
      <p>Manage purchase invoices and track payment status</p>
    </div>
    <button class="btn-add" (click)="openForm()">+ Add Invoice</button>
  </div>

  <!-- Stats Cards -->
  <div class="stats-grid">
    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #667eea, #764ba2);">
        <i class="fas fa-file-invoice"></i>
      </div>
      <div class="stat-content">
        <h3>Total Invoices</h3>
        <p class="stat-value">{{ (invoices$ | async)?.length || 0 }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #f093fb, #f5576c);">
        <i class="fas fa-money-bill-wave"></i>
      </div>
      <div class="stat-content">
        <h3>Total Purchased</h3>
        <p class="stat-value">₹{{ getTotalPurchased() | number:'1.2-2' }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #4facfe, #00f2fe);">
        <i class="fas fa-check-circle"></i>
      </div>
      <div class="stat-content">
        <h3>Paid</h3>
        <p class="stat-value">{{ getPaidCount() }}</p>
      </div>
    </div>

    <div class="stat-card">
      <div class="stat-icon" style="background: linear-gradient(135deg, #fa709a, #fee140);">
        <i class="fas fa-hourglass-end"></i>
      </div>
      <div class="stat-content">
        <h3>Pending</h3>
        <p class="stat-value">{{ getPendingCount() }}</p>
      </div>
    </div>
  </div>

  <!-- Search & Filter -->
  <div class="search-filter">
    <div class="search-box">
      <i class="fas fa-search"></i>
      <input type="text" 
        placeholder="Search by invoice number or supplier..."
        [(ngModel)]="searchQuery">
    </div>

    <div class="filter-select">
      <select [(ngModel)]="filterStatus">
        <option value="">All Statuses</option>
        <option *ngFor="let status of statuses$ | async" [value]="status">
          {{ status }}
        </option>
      </select>
    </div>

    <button class="btn-clear" (click)="clearFilters()">Clear Filters</button>
  </div>

  <!-- Invoices Table -->
  <div class="table-container">
    <table class="invoices-table" *ngIf="(filteredInvoices$ | async)?.length; else noData">
      <thead>
        <tr>
          <th>Invoice No</th>
          <th>Supplier</th>
          <th>Date</th>
          <th>Amount</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let invoice of filteredInvoices$ | async">
          <td class="invoice-no">{{ invoice.invoiceNo }}</td>
          <td>{{ invoice.supplier }}</td>
          <td>{{ invoice.date }}</td>
          <td class="amount">₹{{ invoice.total | number:'1.2-2' }}</td>
          <td>
            <span class="status-badge" [ngClass]="getStatusClass(invoice.status)">
              {{ invoice.status }}
            </span>
          </td>
          <td class="actions">
            <button class="btn-action view-btn" (click)="viewDetails(invoice)" title="View Details">
              <i class="fas fa-eye"></i>
            </button>
            <button class="btn-action edit-btn" (click)="editInvoice(invoice)" title="Edit">
              <i class="fas fa-edit"></i>
            </button>
            <button class="btn-action delete-btn" (click)="deleteInvoice(invoice)" title="Delete">
              <i class="fas fa-trash"></i>
            </button>
          </td>
        </tr>
      </tbody>
    </table>

    <ng-template #noData>
      <div class="no-data">
        <i class="fas fa-inbox"></i>
        <h3>No Invoices Found</h3>
        <p>{{ searchQuery || filterStatus ? 'Try adjusting your filters' : 'Start by creating a new purchase invoice' }}</p>
      </div>
    </ng-template>
  </div>

  <!-- Add/Edit Form Modal -->
  <div class="modal-overlay" *ngIf="showForm" (click)="closeForm()">
    <div class="modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>{{ isEditMode ? 'Edit Invoice' : 'Add New Invoice' }}</h2>
        <button class="btn-close" (click)="closeForm()">&times;</button>
      </div>

      <div class="modal-body">
        <div class="form-group">
          <label>Invoice Number *</label>
          <input type="text" 
            [(ngModel)]="formData.invoiceNo"
            placeholder="e.g., PINV-2024-001">
        </div>

        <div class="form-group">
          <label>Supplier *</label>
          <select [(ngModel)]="formData.supplier">
            <option value="">Select Supplier</option>
            <option *ngFor="let supplier of suppliers$ | async" [value]="supplier">
              {{ supplier }}
            </option>
          </select>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Date *</label>
            <input type="date" [(ngModel)]="formData.date">
          </div>
          <div class="form-group">
            <label>Due Date</label>
            <input type="date" [(ngModel)]="formData.dueDate">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Subtotal (₹)</label>
            <input type="number" 
              [(ngModel)]="formData.subtotal"
              (change)="formData.taxAmount = (formData.subtotal || 0) * (formData.taxRate || 10) / 100; formData.total = (formData.subtotal || 0) + (formData.taxAmount || 0)"
              placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Tax Rate (%)</label>
            <input type="number" 
              [(ngModel)]="formData.taxRate"
              (change)="formData.taxAmount = (formData.subtotal || 0) * (formData.taxRate || 10) / 100; formData.total = (formData.subtotal || 0) + (formData.taxAmount || 0)"
              min="0" max="100" placeholder="10">
          </div>
        </div>

        <div class="form-row">
          <div class="form-group">
            <label>Tax Amount (₹)</label>
            <input type="number" 
              [(ngModel)]="formData.taxAmount"
              disabled
              placeholder="0.00">
          </div>
          <div class="form-group">
            <label>Total Amount (₹)</label>
            <input type="number" 
              [(ngModel)]="formData.total"
              disabled
              placeholder="0.00">
          </div>
        </div>

        <div class="form-group">
          <label>Status</label>
          <select [(ngModel)]="formData.status">
            <option *ngFor="let status of statuses$ | async" [value]="status">
              {{ status }}
            </option>
          </select>
        </div>

        <div class="form-group">
          <label>Notes</label>
          <textarea [(ngModel)]="formData.notes"
            placeholder="Add any notes about this invoice..."
            rows="3"></textarea>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-cancel" (click)="closeForm()">Cancel</button>
        <button class="btn-save" (click)="saveInvoice()">Save Invoice</button>
      </div>
    </div>
  </div>

  <!-- Detail View Modal -->
  <div class="modal-overlay" *ngIf="showDetailModal && selectedInvoice" (click)="closeDetailModal()">
    <div class="modal detail-modal" (click)="$event.stopPropagation()">
      <div class="modal-header">
        <h2>Invoice Details - {{ selectedInvoice.invoiceNo }}</h2>
        <button class="btn-close" (click)="closeDetailModal()">&times;</button>
      </div>

      <div class="modal-body detail-body">
        <div class="detail-row">
          <div class="detail-item">
            <span class="label">Invoice Number:</span>
            <span class="value">{{ selectedInvoice.invoiceNo }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Status:</span>
            <span class="status-badge" [ngClass]="getStatusClass(selectedInvoice.status)">
              {{ selectedInvoice.status }}
            </span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-item">
            <span class="label">Supplier:</span>
            <span class="value">{{ selectedInvoice.supplier }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Date:</span>
            <span class="value">{{ selectedInvoice.date }}</span>
          </div>
        </div>

        <div class="detail-row">
          <div class="detail-item">
            <span class="label">Due Date:</span>
            <span class="value">{{ selectedInvoice.dueDate }}</span>
          </div>
          <div class="detail-item">
            <span class="label">Created:</span>
            <span class="value">{{ selectedInvoice.created | date:'short' }}</span>
          </div>
        </div>

        <div class="detail-divider"></div>

        <h4>Items</h4>
        <div class="items-list" *ngIf="selectedInvoice.items?.length; else noItems">
          <div class="item" *ngFor="let item of selectedInvoice.items">
            <div class="item-name">{{ item.item }}</div>
            <div class="item-qty">Qty: {{ item.quantity }}</div>
            <div class="item-rate">Rate: ₹{{ item.rate }}</div>
            <div class="item-amount">₹{{ item.amount | number:'1.2-2' }}</div>
          </div>
        </div>
        <ng-template #noItems>
          <p class="no-items">No items added</p>
        </ng-template>

        <div class="detail-divider"></div>

        <div class="amount-summary">
          <div class="amount-row">
            <span>Subtotal:</span>
            <span>₹{{ selectedInvoice.subtotal | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row">
            <span>Tax ({{ selectedInvoice.taxRate }}%):</span>
            <span>₹{{ selectedInvoice.taxAmount | number:'1.2-2' }}</span>
          </div>
          <div class="amount-row total">
            <span>Total:</span>
            <span>₹{{ selectedInvoice.total | number:'1.2-2' }}</span>
          </div>
        </div>

        <div *ngIf="selectedInvoice.notes" class="notes">
          <strong>Notes:</strong>
          <p>{{ selectedInvoice.notes }}</p>
        </div>
      </div>

      <div class="modal-footer">
        <button class="btn-edit" (click)="editInvoice(selectedInvoice); closeDetailModal()">Edit</button>
        <button class="btn-cancel" (click)="closeDetailModal()">Close</button>
      </div>
    </div>
  </div>
</div>
